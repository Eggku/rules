name: 自动转换并发布 Release

on:
  schedule:
    - cron: "0 0 * * *"  # 每天运行一次
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: 🛠 检出仓库代码
        uses: actions/checkout@v3

      - name: ⚙️ 确保 `mihomo.exe` 存在
        run: |
          if not exist config\mihomo.exe (
            echo "⚠️ 错误：未找到 config\mihomo.exe，请手动上传！" && exit 1
          )
        shell: cmd

      - name: 🔍 检查 YAML 文件是否存在
        run: |
          if not exist rules\domain-direct.yaml (
            echo "❌ 错误：缺少 rules\domain-direct.yaml" && exit 1
          )
          if not exist rules\domain-proxy.yaml (
            echo "❌ 错误：缺少 rules\domain-proxy.yaml" && exit 1
          )
          if not exist rules\ip-direct.yaml (
            echo "❌ 错误：缺少 rules\ip-direct.yaml" && exit 1
          )
          if not exist rules\ip-proxy.yaml (
            echo "❌ 错误：缺少 rules\ip-proxy.yaml" && exit 1
          )
        shell: cmd

      - name: 🛠 赋予 `mihomo.exe` 执行权限
        run: icacls config\mihomo.exe /grant Everyone:F /T
        shell: cmd

      - name: 🛠 确保 `rules/` 目录存在
        run: |
          if not exist rules (
            mkdir rules
          )
          if not exist rules\mrs (
            mkdir rules\mrs
          )
        shell: cmd

      - name: 🛠 列出 `rules/` 目录内容
        run: dir "rules"
        shell: cmd

      - name: ⚙️ 运行 `.yaml` 转换
        run: |
          config\mihomo.exe convert-ruleset domain yaml rules\domain-direct.yaml rules\mrs\domain-direct.mrs
          config\mihomo.exe convert-ruleset domain yaml rules\domain-proxy.yaml rules\mrs\domain-proxy.mrs
          config\mihomo.exe convert-ruleset ipcidr yaml rules\ip-direct.yaml rules\mrs\ip-direct.mrs
          config\mihomo.exe convert-ruleset ipcidr yaml rules\ip-proxy.yaml rules\mrs\ip-proxy.mrs
        shell: cmd

      - name: 🧪 强制输出 `conversion.log`
        run: |
          if exist conversion.log (
            type conversion.log
          ) else (
            echo "⚠️ 错误：未找到 conversion.log，可能转换过程未执行！"
          )
        shell: cmd

      - name: 📂 列出 `.mrs` 文件
        run: dir "rules/mrs"
        shell: cmd

      - name: ✅ 确保 `.mrs` 文件已生成
        run: |
          dir "rules\mrs" | findstr ".mrs" >nul || (echo "⚠️ 错误：未找到转换后的 .mrs 文件！" && exit 1)
        shell: cmd

      - name: 📦 打包 `.mrs` 文件
        run: powershell Compress-Archive -Path rules/mrs/* -DestinationPath rules/mrs-release.zip
        shell: powershell

      - name: 🚀 生成 Release 版本号
        id: get_date
        run: |
          echo "TAG_NAME=$(Get-Date -Format 'yyyyMMdd')" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: powershell

      - name: 🚀 发布 GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: rules/mrs-release.zip
          tag_name: ${{ env.TAG_NAME }}
          name: "规则更新 - ${{ env.TAG_NAME }}"
          body: |
            🚀 最新转换规则
            - 更新时间: ${{ env.TAG_NAME }}
            - 文件: `.mrs` 规则集
          draft: false
          prerelease: false
