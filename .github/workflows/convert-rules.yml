name: è‡ªåŠ¨è½¬æ¢å¹¶å‘å¸ƒ Release

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤© UTC æ—¶é—´ 00:00 è¿è¡Œï¼ˆåŒ—äº¬æ—¶é—´ 8:00ï¼‰
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      # ----------------------------------------
      # 1. å‡†å¤‡é˜¶æ®µ
      # ----------------------------------------
      - name: ğŸ›  æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: âš™ï¸ éªŒè¯ mihomo.exe å­˜åœ¨
        run: |
          if not exist config\mihomo.exe (
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ config/mihomo.exeï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ ï¼" && exit 1
          )
        shell: cmd

      # ----------------------------------------
      # 2. åˆå§‹åŒ–ç›®å½•ç»“æ„
      # ----------------------------------------
      - name: ğŸ—‚ åˆ›å»º mrs è¾“å‡ºç›®å½•
        run: |
          mkdir rules\mrs 2>nul || echo.
        shell: cmd

      - name: ğŸ“‚ åˆ—å‡º rules ç›®å½•å†…å®¹
        run: dir /b rules
        shell: cmd

      # ----------------------------------------
      # 3. è§„åˆ™è½¬æ¢é˜¶æ®µ
      # ----------------------------------------
      - name: ğŸ” æ£€æŸ¥ YAML æ–‡ä»¶å­˜åœ¨æ€§
        run: |
          if not exist rules\domain-dircet.yaml (
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ rules/domain-direct.yaml" && exit 1
          )
          if not exist rules\domain-proxy.yaml (
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ rules/domain-proxy.yaml" && exit 1
          )
          if not exist rules\ip-direct.yaml (
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ rules/ip-direct.yaml" && exit 1
          )
          if not exist rules\ip-proxy.yaml (
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ rules/ip-proxy.yaml" && exit 1
          )
        shell: cmd

      - name: âš™ï¸ æ‰§è¡Œè§„åˆ™è½¬æ¢
        run: |
          config\mihomo.exe convert-ruleset domain yaml rules\domain-direct.yaml rules\mrs\domain-direct.mrs
          config\mihomo.exe convert-ruleset domain yaml rules\domain-proxy.yaml rules\mrs\domain-proxy.mrs
          config\mihomo.exe convert-ruleset ipcidr yaml rules\ip-direct.yaml rules\mrs\ip-direct.mrs
          config\mihomo.exe convert-ruleset ipcidr yaml rules\ip-proxy.yaml rules\mrs\ip-proxy.mrs
        shell: cmd

      # ----------------------------------------
      # 4. éªŒè¯è¾“å‡ºæ–‡ä»¶
      # ----------------------------------------
      - name: ğŸ§ª æ£€æŸ¥ .mrs æ–‡ä»¶ç”Ÿæˆ
        run: |
          dir rules\mrs | findstr ".mrs" >nul || (
            echo "âŒ é”™è¯¯ï¼šæœªç”Ÿæˆ .mrs æ–‡ä»¶" && exit 1
          )
        shell: cmd

      # ----------------------------------------
      # 5. æ‰“åŒ…å‘å¸ƒé˜¶æ®µ
      # ----------------------------------------
      - name: ğŸ“¦ å‹ç¼©è§„åˆ™æ–‡ä»¶
        run: |
          $zipPath = "rules\mrs-release.zip"
          Compress-Archive -Path rules\mrs\*.mrs -DestinationPath $zipPath
          if (-not (Test-Path $zipPath)) {
            Write-Error "âŒ ZIP æ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          }
        shell: powershell

      - name: ğŸš€ ç”Ÿæˆæ—¥æœŸæ ‡ç­¾
        id: set_tag
        run: |
          echo "TAG_NAME=$(Get-Date -Format 'yyyyMMdd')" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: powershell

      - name: ğŸš€ å‘å¸ƒ GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            rules/mrs-release.zip
          tag_name: ${{ env.TAG_NAME }}
          name: "è§„åˆ™æ›´æ–° - ${{ env.TAG_NAME }}"
          body: |
            ğŸ•’ ç”Ÿæˆæ—¶é—´: ${{ env.TAG_NAME }}
            ğŸ“‚ åŒ…å«æ–‡ä»¶:
            - `domain-direct.mrs`
            - `domain-proxy.mrs`
            - `ip-direct.mrs`
            - `ip-proxy.mrs`
          draft: false
          prerelease: false
