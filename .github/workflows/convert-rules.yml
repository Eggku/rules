name: è‡ªåŠ¨è½¬æ¢å¹¶æ¨é€ `.mrs` æ–‡ä»¶

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©è¿è¡Œä¸€æ¬¡
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ›  æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ›  èµ‹äºˆ Mihomo æ‰§è¡Œæƒé™ï¼ˆæœ¬åœ°æ–‡ä»¶ï¼‰
        run: chmod +x config/mihomo
        shell: bash

      - name: ğŸ›  ç¡®ä¿ `rules/mrs/` ç›®å½•æ­£ç¡®åˆ›å»º
        run: |
          mkdir -p rules/mrs
          chmod -R 777 rules/mrs
        shell: bash

      - name: âš™ï¸ è¿è¡Œ `.yaml` è½¬æ¢ï¼ˆä½¿ç”¨æœ¬åœ° Mihomoï¼‰
        run: |
          config/mihomo convert-ruleset domain yaml rules/domain-direct.yaml rules/mrs/domain-direct.mrs
          config/mihomo convert-ruleset domain yaml rules/domain-proxy.yaml rules/mrs/domain-proxy.mrs
          config/mihomo convert-ruleset ipcidr yaml rules/ip-direct.yaml rules/mrs/ip-direct.mrs
          config/mihomo convert-ruleset ipcidr yaml rules/ip-proxy.yaml rules/mrs/ip-proxy.mrs
        shell: bash

      - name: ğŸ“‚ ç¡®ä¿ `.mrs` æ–‡ä»¶å·²ç”Ÿæˆ
        run: |
          ls rules/mrs/*.mrs || (echo "âš ï¸ é”™è¯¯ï¼šæœªæ‰¾åˆ°è½¬æ¢åçš„ `.mrs` æ–‡ä»¶ï¼" && exit 1)
        shell: bash

      - name: ğŸš€ æ¨é€ `.mrs` æ–‡ä»¶åˆ° GitHub ä»“åº“ `main` åˆ†æ”¯
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"
          git add rules/mrs/*.mrs
          git commit -m "ğŸš€ æ›´æ–° `.mrs` æ–‡ä»¶ - $(date +'%Y-%m-%d')"
          git push origin main
        shell: bash
