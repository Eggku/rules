name: 自动转换并发布 Release

on:
  schedule:
    - cron: "0 0 * * *"  # 每天 UTC 时间 00:00 运行（北京时间 8:00）
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      # ----------------------------------------
      # 1. 准备阶段
      # ----------------------------------------
      - name: 🛠 检出仓库代码
        uses: actions/checkout@v3

      - name: ⚙️ 验证 mihomo.exe 存在
        run: |
          if not exist config\mihomo.exe (
            echo "❌ 错误：缺少 config/mihomo.exe，请手动上传！" && exit 1
          )
        shell: cmd

      # ----------------------------------------
      # 2. 初始化目录结构
      # ----------------------------------------
      - name: 🗂 创建 mrs 输出目录
        run: |
          mkdir rules\mrs 2>nul || echo.
        shell: cmd

      - name: 📂 列出 rules 目录内容
        run: dir /b rules
        shell: cmd

      # ----------------------------------------
      # 3. 规则转换阶段
      # ----------------------------------------
      - name: 🔍 检查 YAML 文件存在性
        run: |
          if not exist rules\domain-dircet.yaml (
            echo "❌ 错误：缺少 rules/domain-direct.yaml" && exit 1
          )
          if not exist rules\domain-proxy.yaml (
            echo "❌ 错误：缺少 rules/domain-proxy.yaml" && exit 1
          )
          if not exist rules\ip-direct.yaml (
            echo "❌ 错误：缺少 rules/ip-direct.yaml" && exit 1
          )
          if not exist rules\ip-proxy.yaml (
            echo "❌ 错误：缺少 rules/ip-proxy.yaml" && exit 1
          )
        shell: cmd

      - name: ⚙️ 执行规则转换
        run: |
          config\mihomo.exe convert-ruleset domain yaml rules\domain-direct.yaml rules\mrs\domain-direct.mrs
          config\mihomo.exe convert-ruleset domain yaml rules\domain-proxy.yaml rules\mrs\domain-proxy.mrs
          config\mihomo.exe convert-ruleset ipcidr yaml rules\ip-direct.yaml rules\mrs\ip-direct.mrs
          config\mihomo.exe convert-ruleset ipcidr yaml rules\ip-proxy.yaml rules\mrs\ip-proxy.mrs
        shell: cmd

      # ----------------------------------------
      # 4. 验证输出文件
      # ----------------------------------------
      - name: 🧪 检查 .mrs 文件生成
        run: |
          dir rules\mrs | findstr ".mrs" >nul || (
            echo "❌ 错误：未生成 .mrs 文件" && exit 1
          )
        shell: cmd

      # ----------------------------------------
      # 5. 打包发布阶段
      # ----------------------------------------
      - name: 📦 压缩规则文件
        run: |
          $zipPath = "rules\mrs-release.zip"
          Compress-Archive -Path rules\mrs\*.mrs -DestinationPath $zipPath
          if (-not (Test-Path $zipPath)) {
            Write-Error "❌ ZIP 文件未生成"
            exit 1
          }
        shell: powershell

      - name: 🚀 生成日期标签
        id: set_tag
        run: |
          echo "TAG_NAME=$(Get-Date -Format 'yyyyMMdd')" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: powershell

      - name: 🚀 发布 GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            rules/mrs-release.zip
          tag_name: ${{ env.TAG_NAME }}
          name: "规则更新 - ${{ env.TAG_NAME }}"
          body: |
            🕒 生成时间: ${{ env.TAG_NAME }}
            📂 包含文件:
            - `domain-direct.mrs`
            - `domain-proxy.mrs`
            - `ip-direct.mrs`
            - `ip-proxy.mrs`
          draft: false
          prerelease: false
