name: è‡ªåŠ¨è½¬æ¢å¹¶å‘å¸ƒ Release

on:
  schedule:
    - cron: "0 0 * * *"
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ›  æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: âš™ï¸ éªŒè¯ mihomo.exe å­˜åœ¨
        run: |
          if not exist config\mihomo.exe (
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ config/mihomo.exe" && exit 1
          )
        shell: cmd

      - name: âš™ï¸ æ‰§è¡Œè½¬æ¢å‘½ä»¤
        run: |
          config\mihomo.exe convert-ruleset domain yaml config\rules\domain-direct.yaml config\rules\mrs\domain-direct.mrs
          config\mihomo.exe convert-ruleset domain yaml config\rules\domain-proxy.yaml config\rules\mrs\domain-proxy.mrs
          config\mihomo.exe convert-ruleset ipcidr yaml config\rules\ip-direct.yaml config\rules\mrs\ip-direct.mrs
          config\mihomo.exe convert-ruleset ipcidr yaml config\rules\ip-proxy.yaml config\rules\mrs\ip-proxy.mrs
        shell: cmd

      - name: ğŸ“ æ”¶é›†ç”Ÿæˆçš„æ–‡ä»¶å
        id: collect_files
        run: |
          cd config\rules\mrs
          dir /b *.mrs | tr "\n" "," > temp.txt
          set /p FILES=<temp.txt
          echo "FILES=%FILES:,%=%" >> %GITHUB_OUTPUT%
        shell: cmd

      - name: ğŸš€ ç”Ÿæˆæ—¥æœŸæ ‡ç­¾
        id: set_tag
        run: |
          echo "TAG_NAME=$(Get-Date -Format 'yyyyMMdd')" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: powershell

      - name: ğŸš€ å‘å¸ƒ GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG_NAME }}
          name: "è§„åˆ™æ›´æ–° - ${{ env.TAG_NAME }}"
          body: |
            ğŸ•’ ç”Ÿæˆæ—¶é—´: ${{ env.TAG_NAME }}
            ğŸ“‚ ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨:
            - ${{ join( fromJSON( format('[ "{0}" ]', replace(steps.collect_files.outputs.FILES, ',', '", "')) ), '\n- ') }}
          draft: false
          prerelease: false
