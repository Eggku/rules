name: è‡ªåŠ¨è½¬æ¢å¹¶å‘å¸ƒ Release

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©è¿è¡Œä¸€æ¬¡
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ›  æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: âš™ï¸ ç¡®ä¿ `mihomo.exe` å­˜åœ¨
        run: |
          if not exist config\mihomo.exe (
            echo "âš ï¸ é”™è¯¯ï¼šæœªæ‰¾åˆ° config\mihomo.exeï¼Œè¯·æ‰‹åŠ¨ä¸Šä¼ ï¼" && exit 1
          )
        shell: cmd

      - name: ğŸ” æ£€æŸ¥ YAML æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        run: |
          if not exist rules\domain-direct.yaml (
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ rules\domain-direct.yaml" && exit 1
          )
          if not exist rules\domain-proxy.yaml (
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ rules\domain-proxy.yaml" && exit 1
          )
          if not exist rules\ip-direct.yaml (
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ rules\ip-direct.yaml" && exit 1
          )
          if not exist rules\ip-proxy.yaml (
            echo "âŒ é”™è¯¯ï¼šç¼ºå°‘ rules\ip-proxy.yaml" && exit 1
          )
        shell: cmd

      - name: ğŸ›  èµ‹äºˆ `mihomo.exe` æ‰§è¡Œæƒé™
        run: icacls config\mihomo.exe /grant Everyone:F /T
        shell: cmd

      - name: ğŸ›  ç¡®ä¿ `rules/` ç›®å½•å­˜åœ¨
        run: |
          if not exist rules (
            mkdir rules
          )
          if not exist rules\mrs (
            mkdir rules\mrs
          )
        shell: cmd

      - name: ğŸ›  åˆ—å‡º `rules/` ç›®å½•å†…å®¹
        run: dir "rules"
        shell: cmd

      - name: âš™ï¸ è¿è¡Œ `.yaml` è½¬æ¢
        run: |
          config\mihomo.exe convert-ruleset domain yaml rules\domain-direct.yaml rules\mrs\domain-direct.mrs
          config\mihomo.exe convert-ruleset domain yaml rules\domain-proxy.yaml rules\mrs\domain-proxy.mrs
          config\mihomo.exe convert-ruleset ipcidr yaml rules\ip-direct.yaml rules\mrs\ip-direct.mrs
          config\mihomo.exe convert-ruleset ipcidr yaml rules\ip-proxy.yaml rules\mrs\ip-proxy.mrs
        shell: cmd

      - name: ğŸ§ª å¼ºåˆ¶è¾“å‡º `conversion.log`
        run: |
          if exist conversion.log (
            type conversion.log
          ) else (
            echo "âš ï¸ é”™è¯¯ï¼šæœªæ‰¾åˆ° conversion.logï¼Œå¯èƒ½è½¬æ¢è¿‡ç¨‹æœªæ‰§è¡Œï¼"
          )
        shell: cmd

      - name: ğŸ“‚ åˆ—å‡º `.mrs` æ–‡ä»¶
        run: dir "rules/mrs"
        shell: cmd

      - name: âœ… ç¡®ä¿ `.mrs` æ–‡ä»¶å·²ç”Ÿæˆ
        run: |
          dir "rules\mrs" | findstr ".mrs" >nul || (echo "âš ï¸ é”™è¯¯ï¼šæœªæ‰¾åˆ°è½¬æ¢åçš„ .mrs æ–‡ä»¶ï¼" && exit 1)
        shell: cmd

      - name: ğŸ“¦ æ‰“åŒ… `.mrs` æ–‡ä»¶
        run: powershell Compress-Archive -Path rules/mrs/* -DestinationPath rules/mrs-release.zip
        shell: powershell

      - name: ğŸš€ ç”Ÿæˆ Release ç‰ˆæœ¬å·
        id: get_date
        run: |
          echo "TAG_NAME=$(Get-Date -Format 'yyyyMMdd')" | Out-File -FilePath $env:GITHUB_ENV -Append
        shell: powershell

      - name: ğŸš€ å‘å¸ƒ GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: rules/mrs-release.zip
          tag_name: ${{ env.TAG_NAME }}
          name: "è§„åˆ™æ›´æ–° - ${{ env.TAG_NAME }}"
          body: |
            ğŸš€ æœ€æ–°è½¬æ¢è§„åˆ™
            - æ›´æ–°æ—¶é—´: ${{ env.TAG_NAME }}
            - æ–‡ä»¶: `.mrs` è§„åˆ™é›†
          draft: false
          prerelease: false
