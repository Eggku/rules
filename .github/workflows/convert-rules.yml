name: è‡ªåŠ¨è½¬æ¢å¹¶å‘å¸ƒ Release

on:
  schedule:
    - cron: "0 0 * * *"  # æ¯å¤©è¿è¡Œä¸€æ¬¡
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  convert-rules:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ğŸ›  æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v3

      - name: ğŸ›  èµ‹äºˆ Mihomo æ‰§è¡Œæƒé™ï¼ˆæœ¬åœ°æ–‡ä»¶ï¼‰
        run: chmod +x config/mihomo
        shell: bash

      - name: ğŸ›  ç¡®ä¿ `rules/mrs/` ç›®å½•æ­£ç¡®åˆ›å»º
        run: |
          mkdir -p rules/mrs
          chmod -R 777 rules/mrs
        shell: bash

      - name: âš™ï¸ è¿è¡Œ `.yaml` è½¬æ¢ï¼ˆä½¿ç”¨æœ¬åœ° Mihomoï¼‰
        run: |
          config/mihomo convert-ruleset domain yaml rules/domain-direct.yaml rules/mrs/domain-direct.mrs || echo "âš ï¸ domain-direct è§„åˆ™è½¬æ¢å¤±è´¥"
          config/mihomo convert-ruleset domain yaml rules/domain-proxy.yaml rules/mrs/domain-proxy.mrs || echo "âš ï¸ domain-proxy è§„åˆ™è½¬æ¢å¤±è´¥"
          config/mihomo convert-ruleset ipcidr yaml rules/ip-direct.yaml rules/mrs/ip-direct.mrs || echo "âš ï¸ ip-direct è§„åˆ™è½¬æ¢å¤±è´¥"
          config/mihomo convert-ruleset ipcidr yaml rules/ip-proxy.yaml rules/mrs/ip-proxy.mrs || echo "âš ï¸ ip-proxy è§„åˆ™è½¬æ¢å¤±è´¥"
        shell: bash

      - name: ğŸ“‚ åˆ—å‡º `.mrs` æ–‡ä»¶
        run: ls -l rules/mrs || echo "âš ï¸ `rules/mrs` ç›®å½•ä¸ºç©ºï¼Œå¯èƒ½è½¬æ¢å¤±è´¥"
        shell: bash

      - name: âœ… ç¡®ä¿ `.mrs` æ–‡ä»¶å·²ç”Ÿæˆ
        run: |
          ls rules/mrs/*.mrs || (echo "âš ï¸ é”™è¯¯ï¼šæœªæ‰¾åˆ°è½¬æ¢åçš„ `.mrs` æ–‡ä»¶ï¼" && exit 1)
        shell: bash

      - name: ğŸš€ å‘å¸ƒ GitHub Releaseï¼ˆå§‹ç»ˆæ›´æ–° `latest`ï¼‰
        uses: softprops/action-gh-release@v1
        with:
          files: rules/mrs/*.mrs  # ğŸ”„ ç›´æ¥ä¸Šä¼  `.mrs` æ–‡ä»¶
          tag_name: latest  # ğŸ”„ å§‹ç»ˆè¦†ç›– `latest` è¿™ä¸ª Release
          name: "Mihomo - æœ€æ–°ç‰ˆ"
          body: |
            ğŸ“Œ **Mihomo/Clash è§„åˆ™æ•´ç†ï¼ˆå§‹ç»ˆä¿æŒæœ€æ–°ï¼‰**
            - ğŸ’¾ å›ºå®šä¸‹è½½é“¾æ¥ï¼š
            - [åŸŸåç›´è¿è§„åˆ™](https://github.com/${{ github.repository }}/releases/download/latest/domain-direct.mrs)
            - [åŸŸåä»£ç†è§„åˆ™](https://github.com/${{ github.repository }}/releases/download/latest/domain-proxy.mrs)
            - [IP ç›´è¿è§„åˆ™](https://github.com/${{ github.repository }}/releases/download/latest/ip-direct.mrs)
            - [IP ä»£ç†è§„åˆ™](https://github.com/${{ github.repository }}/releases/download/latest/ip-proxy.mrs)

            ğŸŸ **Mihomo/Clash æ”¶å½•[ğŸŸæ¼ç½‘ä¹‹é±¼]æœªè¢« `cn_domain`ï¼ˆå›½å†…ï¼‰æˆ– `geolocation-!cn`ï¼ˆå›½å¤–ï¼‰æ”¶å½•çš„è§„åˆ™é›†**ï¼Œå¸®åŠ©æ‚¨æ›´ç²¾å‡†åœ°ç®¡ç†ä»£ç†/ç›´è¿è®¾ç½®ã€‚
          draft: false
          prerelease: false
