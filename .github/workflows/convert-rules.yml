name: 自动转换并发布 Release
on:
  schedule:
    - cron: "0 0 * * *"  # 每 24 小时运行一次（每天午夜）
  push:
    branches:
      - main  # 监听 `main` 分支的代码变更
  workflow_dispatch:  # 允许手动运行

jobs:
  convert-rules:
    runs-on: windows-latest
    permissions:
      contents: write  # 允许发布 Release
    steps:
      - name: 🛠 检出仓库代码
        uses: actions/checkout@v3

      - name: 🔄 下载 `mihomo.exe`
        run: |
          curl -L -o config/mihomo.exe "https://your-download-link.com/mihomo.exe"
          ls config  # ✅ 确保 `mihomo.exe` 下载正确
        shell: bash

      - name: 🛠 运行 `.bat` 转换脚本
        run: |
          echo "启动转换脚本..." >> conversion.log
          cmd /c "%GITHUB_WORKSPACE%\config\auto-convert.bat"
        shell: cmd

      - name: ✅ 检查 `.mrs` 文件是否生成
        shell: cmd
        run: |
          if exist rules\mrs\*.mrs (
          echo "✅ .mrs 文件已成功生成！"
          ) else (
          echo "⚠️ 错误：未找到转换后的 .mrs 文件！"
          exit 1
          )



      - name: 📦 打包转换后的 `.mrs` 文件
        run: |
          powershell Compress-Archive -Path rules/mrs/* -DestinationPath rules/mrs-release.zip
        shell: powershell

      - name: 🚀 生成 Release 版本号
        id: get_date
        run: echo "TAG_NAME=$(date +'%Y%m%d')" >> $GITHUB_ENV
        shell: bash

      - name: 🚀 发布 GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: rules/mrs/*.mrs  # ✅ 确保发布的是 `.mrs` 文件
          tag_name: ${{ env.TAG_NAME }}
          name: "规则更新 - ${{ env.TAG_NAME }}"
          body: |
            🚀 **最新转换规则**
            - **更新时间:** ${{ env.TAG_NAME }}
            - **文件:** `.mrs` 规则集
          draft: false
          prerelease: false
